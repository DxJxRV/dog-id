// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(uuid())
  nombre        String
  email         String   @unique
  passwordHash  String   @map("password_hash")
  googleId      String?  @unique @map("google_id")
  fotoUrl       String?  @map("foto_url")
  coverPhotoUrl String?  @map("cover_photo_url")
  telefono      String?
  friendCode    String?  @unique @map("friend_code")
  createdAt     DateTime @default(now()) @map("created_at")

  pets              Pet[]
  coOwnedPets       CoOwnerPetLink[]
  sentFriendships   Friendship[] @relation("SentFriendships")
  receivedFriendships Friendship[] @relation("ReceivedFriendships")

  @@map("users")
}

model Vet {
  id                  String   @id @default(uuid())
  nombre              String
  email               String   @unique
  passwordHash        String   @map("password_hash")
  cedulaProfesional   String   @map("cedula_profesional")
  telefono            String?
  fotoUrl             String?  @map("foto_url")
  coverPhotoUrl       String?  @map("cover_photo_url")
  createdAt           DateTime @default(now()) @map("created_at")

  vaccines            Vaccine[]
  procedures          Procedure[]
  linkedPets          VetPetLink[]
  createdPets         Pet[]

  @@map("vets")
}

model Pet {
  id                      String    @id @default(uuid())
  userId                  String?   @map("user_id")
  nombre                  String
  especie                 String
  raza                    String?
  fechaNacimiento         DateTime? @map("fecha_nacimiento")
  fotoUrl                 String?   @map("foto_url")
  coverPhotoUrl           String?   @map("cover_photo_url")
  linkCode                String?   @unique @map("link_code")
  archivedByOwner         Boolean   @default(false) @map("archived_by_owner")
  transferCode            String?   @unique @map("transfer_code")
  transferCodeExpiresAt   DateTime? @map("transfer_code_expires_at")
  createdByVetId          String?   @map("created_by_vet_id")
  pendingTransfer         Boolean   @default(false) @map("pending_transfer")
  createdAt               DateTime  @default(now()) @map("created_at")

  user             User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdByVet     Vet?      @relation(fields: [createdByVetId], references: [id], onDelete: SetNull)
  vaccines         Vaccine[]
  procedures       Procedure[]
  linkedVets       VetPetLink[]
  coOwners         CoOwnerPetLink[]

  @@map("pets")
}

model Vaccine {
  id             String    @id @default(uuid())
  petId          String    @map("pet_id")
  vetId          String?   @map("vet_id")
  nombreVacuna   String    @map("nombre_vacuna")
  lote           String?
  caducidad      DateTime?
  fechaAplicacion DateTime? @map("fecha_aplicacion")
  evidenciaUrl   String?   @map("evidencia_url")
  ocrRawText     String?   @map("ocr_raw_text") @db.Text
  ocrStatus      String    @default("pending") @map("ocr_status") // success, fail, manual, pending
  createdAt      DateTime  @default(now()) @map("created_at")

  pet            Pet       @relation(fields: [petId], references: [id], onDelete: Cascade)
  vet            Vet?      @relation(fields: [vetId], references: [id], onDelete: SetNull)

  @@map("vaccines")
}

model Procedure {
  id             String    @id @default(uuid())
  petId          String    @map("pet_id")
  vetId          String?   @map("vet_id")
  tipo           String    // desparasitacion, limpieza_dental, cirugia, chequeo_general, radiografia, otro
  descripcion    String    @db.Text
  fecha          DateTime  @default(now())
  evidenciaUrl   String?   @map("evidencia_url")
  createdAt      DateTime  @default(now()) @map("created_at")

  pet            Pet       @relation(fields: [petId], references: [id], onDelete: Cascade)
  vet            Vet?      @relation(fields: [vetId], references: [id], onDelete: SetNull)

  @@map("procedures")
}

model VetPetLink {
  id        String   @id @default(uuid())
  vetId     String   @map("vet_id")
  petId     String   @map("pet_id")
  archived  Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  vet       Vet      @relation(fields: [vetId], references: [id], onDelete: Cascade)
  pet       Pet      @relation(fields: [petId], references: [id], onDelete: Cascade)

  @@unique([vetId, petId])
  @@map("vet_pet_links")
}

model CoOwnerPetLink {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  petId     String   @map("pet_id")
  archived  Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  pet       Pet      @relation(fields: [petId], references: [id], onDelete: Cascade)

  @@unique([userId, petId])
  @@map("co_owner_pet_links")
}

model Friendship {
  id                  String    @id @default(uuid())
  requesterId         String    @map("requester_id")
  addresseeId         String    @map("addressee_id")
  status              String    @default("pending") // pending, accepted, rejected
  acceptedAt          DateTime? @map("accepted_at")
  requesterViewedAt   DateTime? @map("requester_viewed_at")
  addresseeViewedAt   DateTime? @map("addressee_viewed_at")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  requester   User     @relation("SentFriendships", fields: [requesterId], references: [id], onDelete: Cascade)
  addressee   User     @relation("ReceivedFriendships", fields: [addresseeId], references: [id], onDelete: Cascade)

  @@unique([requesterId, addresseeId])
  @@map("friendships")
}
